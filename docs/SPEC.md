SPEC.md (要件定義書)
1. 目的・背景
本システムは、建設現場の作業員がNFCタグを用いて日々の出退勤と作業内容を報告する「NFC日報システム」である。
現在スプレッドシートで手動運用されており、以下の課題を解決する。

課題1: 位置情報の不正確さ: スマートフォンのGPS精度が安定せず、誤った現場での打刻が頻発している。

課題2: 報告の非効率性: 打刻後のデータ転記や集計に多大な工数がかかっている。

課題3: セキュリティリスク: 認証基盤がなく、なりすましや不正アクセスのリスクがある。
本システムはこれらの課題を解消し、報告業務の信頼性と効率性を向上させることを目的とする。

2. スコープ
2.1. スコープ内 (実装対象)
ID/パスワードによるユーザー認証機能 (NextAuth.js Credentials Provider)

URLパラメータ (machineid) による使用機械の識別

スマートフォンブラウザからの出退勤打刻機能

高精度な位置情報取得と最近傍現場の自動判定

打刻ログのAirtableへのリアルタイム記録

各種マスタデータ (従業員, 機械, 現場, 作業内容) のAirtableでの管理

2.2. スコープ外 (実装しない)
管理者向けのダッシュボードやマスタデータ編集画面

オフラインでの打刻機能

勤怠レポートや請求書の自動生成機能

会計・給与計算ソフトとの連携

3. ユースケース一覧
UC-01: ログイン

ユーザーはログイン画面でIDとパスワードを入力し、「ログイン」ボタンを押下する。

システムは認証に成功した場合、セッションを開始し、打刻ページにリダイレクトする。

認証失敗時は、「IDまたはパスワードが正しくありません」と表示する。

UC-02: 出勤打刻

ログイン済みのユーザーがNFCタグをタップし、打刻ページ (/nfc?machineid=...) にアクセスする。

システムはユーザーの当日ログが0件または偶数件であることを確認し、「出勤画面」を表示する。

ユーザーは作業内容をドロップダウンから選択し、「出勤を記録する」ボタンを押下する。

システムは位置情報を取得し、ログを記録する。成功後、自動的に「退勤画面」に遷移する。

UC-03: 退勤打刻

「出勤中」のユーザーが打刻ページにアクセスすると、システムは「退勤画面」を表示する。

画面にはユーザー名、現場名、機械名が表示され、大きく目立つ「退勤する」ボタンが配置される。

ユーザーが「退勤する」ボタンを押下する。

システムは位置情報を取得し、出勤時と同じ作業内容でログを記録する。成功後、「退勤が記録されました」と表示する。

UC-04: 自動ログイン

一度ログインしたユーザーが再度サイトにアクセスした場合、システムは有効なセッションCookieを検知し、ログイン画面をスキップして打刻ページを表示する。

4. 非機能要件
性能:

APIレスポンスタイム (サーバー処理時間): 95パーセンタイルで2秒未満。

Google Core Web Vitals (LCP, FID, CLS) は全て「良好」の基準を満たすこと。

可用性:

システム全体の月間稼働率 SLO: 99.9%

セキュリティ:

通信は全てTLS 1.2以上で暗号化する。

パスワードはArgon2idアルゴリズムでハッシュ化して保存する。

HttpOnly, Secure, SameSite=Strict 属性を付与したCookieでセッションを管理する。

監査:

全ての打刻ログ (Logsテーブル) には、操作者(user), 操作日時(timestamp), 使用機械(machine)の情報を記録する。

5. エラーポリシー
クライアントサイドエラー (4xx系):

リトライは実行しない。

ユーザーには「入力内容が正しくありません」「無効な機械IDです」など、原因がわかるメッセージを即時表示する。

サーバーサイドエラー (5xx系) / ネットワークエラー:

クライアントは指数バックオフ戦略（1秒, 2秒, 4秒）を用いて最大3回までAPIリクエストを自動リトライする。

3回失敗後、「サーバーとの通信に失敗しました。時間をおいて再度お試しください」と表示する。

ログ粒度:

全てのAPIリクエスト（成功/失敗問わず）について、Vercel FunctionsのログにuserId, machineid, レスポンスステータスを記録する。

エラー発生時は、スタックトレースを含む詳細情報を記録する。

6. 用語集
用語

UI文言

説明

出勤処理

出勤を記録する

出勤時の打刻アクション

退勤処理

退勤する

退勤時の打刻アクション

ログインID

ID

認証に用いるユーザー識別子

7. 受入基準 (AC)
UC-02の出勤打刻フローが、ボタン押下から「退勤画面」表示まで5秒以内に完了すること。

UC-03で記録された退勤ログのworkDescriptionが、直前の出勤ログと完全に一致していること。

位置情報のaccuracyが100mを超えるログが記録された場合、管理者に通知する仕組みがあること（将来的な実装でも可）。

サポート対象ブラウザ (最新版のChrome, Safari) で全てのユースケースが正常に完了すること。